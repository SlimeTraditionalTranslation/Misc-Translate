name: RoadMapAction

on:
  workflow_dispatch:
    inputs:
      chooser:
        description: "Choose Manual Run Job"     
        required: true
        default: "Updater"
        type: choice
        options:
        - Updater
        - Sync
  push:
    branches:
      - main
    paths:
      - RoadMap/**
  schedule:
    - cron: "0 16 * * 1"

jobs:

  RoadMapUpdater:
    name: AutoUpdate Roadmap
    runs-on: ubuntu-latest
    if: ${{ inputs.chooser == 'Updater' || github.event_name == 'schedule' }}
    env:
      working-directory: ./RoadMap/
    steps:
      - name: Checking Repostiory
        uses: actions/checkout@v3
      
      - name: Get Slimefun Issus RoadMap
        working-directory: ${{ env.working-directory }}
        run: |
          echo -e "---\ntitle: \"ğŸš€ é»æ¶²ç§‘æŠ€å®˜æ–¹è·¯ç·šåœ–\"\nsidebar_position: 1\n---\n" > RoadMap.md
          echo "Get Issus"
          curl \
          -H "Accept: application/vnd.github+json" \
          https://api.github.com/repos/Slimefun/Slimefun4/issues/3170 | \
          jq -r .body >> RoadMap.md

      - name: Lint RoadMap
        uses: avto-dev/markdown-lint@v1.5.0
        with:
          config: ".github/configs/markdown-lint.yaml"
          args: ./RoadMap/RoadMap.md
          fix: true

      - name: Create Update Pull Request
        uses: peter-evans/create-pull-request@v4
        with:
          title: "[Auto] RoadMap Update"
          body: |
            è‡ªå‹•åŒ–æ›´æ–°é»æ¶²ç§‘æŠ€è·¯ç·šåœ–
            ç”± [create-pull-request](https://github.com/peter-evans/create-pull-request) è£½ä½œ!
          commit-message: "ci: [Auto] RoadMap Update"
          branch: update/roadmap
          delete-branch: true
          assignees: xMikux

      - name: Auto Labeler
        uses: actions/labeler@v4
        with:
          configuration-path: ".github/configs/labeler.yml"
          repo-token: "${{ secrets.GITHUB_TOKEN }}"

      - name: Notify with Discord Webhook
        uses: rjstone/discord-webhook-notify@v1
        with:
          severity: info
          username: RoadMapUpdater
          avatarUrl: https://github.githubassets.com/images/modules/logos_page/Octocat.png
          description: |
            **è·¯ç·šåœ–å·²è‡ªå‹•æ›´æ–°ä¸¦åˆä½µï¼Œéœ€è¦æª¢æŸ¥æœ€æ–°ç¿»è­¯ï¼
            ï¼Š
            **æäº¤ URL:** ${payload.head_commit.url}
          footer: "è‡ªå‹•åŒ–~"
          text: "@Efina#0877"
          webhookUrl: ${{ secrets.DISCORD_WEBHOOK_ADMIN }}

  RoadMapMerge:
    name: Auto Merge RoadMap
    runs-on: ubuntu-latest
    needs: RoadMapUpdater
    steps:
      - name: Merge RoadMap
        uses: "pascalgn/automerge-action@v0.14.3"
        if: needs.label.outputs.status == 'success'
        env:
          GITHUB_TOKEN: "${{ secrets.GITHUB_TOKEN }}"
          MERGE_LABELS: "åˆä½µè·¯ç·šåœ–"
          MERGE_REMOVE_LABELS: "åˆä½µè·¯ç·šåœ–"
          MERGE_COMMIT_MESSAGE: "ci: RoadMap Update #{pullRequest.number}"
          MERGE_REQUIRED_APPROVALS: 0
          MERGE_DELETE_BRANCH: true
          MERGE_METHOD: "squash"
          MERGE_FORKS: "false"
          UPDATE_LABELS: ""
          UPDATE_METHOD: "rebase"

  RoadMapSync:
    name: RoadMap Sync
    runs-on: ubuntu-latest
    if: inputs.chooser == 'Sync'
    steps:
      - name: Checking Repostiory
        uses: actions/checkout@v3

      - name: Checking Change
        id: changed-files
        uses: tj-actions/changed-files@v23.1
        with:
          other_modified_files: |
            RoadMap/RoadMap-zh_TW.md

      - name: Hello World
        if: steps.changed-files-specific.outputs.any_changed == 'true'
        run: echo "hEllo Wo"

      - name: World Hello
        run: echo "Wo Hello"
