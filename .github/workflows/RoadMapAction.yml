name: RoadMapAction

on:
  workflow_dispatch:
    inputs:
      chooser:
        description: "Choose Manual Run Job"     
        required: true
        default: "Updater"
        type: choice
        options:
        - Updater
        - Sync
  push:
    branches:
      - main
    paths:
      - RoadMap/**
  schedule:
    - cron: "0 16 * * 1"

jobs:

  RoadMapUpdater:
    name: AutoUpdate Roadmap
    runs-on: ubuntu-latest
    if: ${{ inputs.chooser == 'Updater' || github.event_name == 'schedule' }}
    env:
      working-directory: ./RoadMap/
    steps:
      - name: Checking Repostiory
        uses: actions/checkout@v3
      
      - name: Get Slimefun Issus RoadMap
        working-directory: ${{ env.working-directory }}
        run: |
          echo -e "---\ntitle: \"🚀 黏液科技官方路線圖\"\nsidebar_position: 1\n---\n" > RoadMap.md
          echo "Get Issus"
          curl \
          -H "Accept: application/vnd.github+json" \
          https://api.github.com/repos/Slimefun/Slimefun4/issues/3170 | \
          jq -r .body >> RoadMap.md

      - name: Lint RoadMap
        uses: avto-dev/markdown-lint@v1.5.0
        with:
          config: ".github/configs/markdown-lint.yaml"
          args: ./RoadMap/RoadMap.md
          fix: true

      - name: Setup git config
        uses: crazy-max/ghaction-import-gpg@v4
        with:
          gpg_private_key: ${{ secrets.GPG_PRIVATE_KEY }}
          passphrase: ${{ secrets.GPG_PASSPHRASE }}
          git_user_signingkey: true
          git_commit_gpgsign: true

      - name: Commit the change
        run: |
          git add .
          git commit -S -m "ci: [Auto] RoadMap Update"
        working-directory: ${{ env.working-directory }}

      - name: Create Update Pull Request
        uses: peter-evans/create-pull-request@v4
        id: cpr
        with:
          title: "[Automated] RoadMap Update"
          body: |
            自動化更新黏液科技路線圖
            由 [create-pull-request](https://github.com/peter-evans/create-pull-request) 製作!
          branch: update/roadmap
          delete-branch: true

      - name: Pull Request Automerge
        if: steps.cpr.outputs.pull-request-operation == 'created'
        uses: peter-evans/enable-pull-request-automerge@v2
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          pull-request-number: ${{ steps.cpr.outputs.pull-request-number }}
          merge-method: squash

      - name: Notify with Discord Webhook
        uses: rjstone/discord-webhook-notify@v1
        with:
          severity: info
          username: RoadMapUpdater
          avatarUrl: https://github.githubassets.com/images/modules/logos_page/Octocat.png
          description: |
            **路線圖已自動更新並合併，需要檢查最新翻譯！**
            **變動合併資訊**：${{ steps.cpr.outputs.pull-request-url }}
          footer: "自動化合併更新"
          text: "<@292313547227136001>"
          webhookUrl: ${{ secrets.DISCORD_WEBHOOK_ADMIN }}

  RoadMapSync:
    name: RoadMap Sync
    runs-on: ubuntu-latest
    if: inputs.chooser == 'Sync'
    steps:
      - name: Checking Repostiory
        uses: actions/checkout@v3

      - name: Checking Change
        id: changed-files
        uses: tj-actions/changed-files@v23.1
        with:
          other_modified_files: |
            RoadMap/RoadMap-zh_TW.md

      - name: Hello World
        if: steps.changed-files-specific.outputs.any_changed == 'true'
        run: echo "hEllo Wo"

      - name: World Hello
        run: echo "Wo Hello"
